# Advanced Azure Event Hubs Configuration
#
# Production-ready configuration with all features enabled

<match production.**>
  @type azureeventhubs

  # Connection Configuration
  connection_string "#{ENV['AZURE_EVENTHUBS_CONNECTION_STRING']}"
  hub_name production-logs

  # Metadata Configuration
  include_tag true
  include_time true
  tag_time_name timestamp

  # Batch Configuration for High Throughput
  batch true
  max_batch_size 100

  # UTF-8 Encoding Safety
  coerce_to_utf8 true
  non_utf8_replacement_string "?"

  # SSL/TLS Configuration
  ssl_verify true

  # Connection Timeouts
  open_timeout 90
  read_timeout 90

  # SAS Token Configuration
  # Token cached for 2 hours, automatically refreshed
  expiry_interval 7200

  # Message Properties for Event Hubs Routing
  message_properties {
    "PartitionKey": "production",
    "application": "myapp",
    "environment": "production",
    "datacenter": "us-east",
    "version": "1.0.0"
  }

  # Debug mode (prints each record)
  print_records false

  # Advanced Buffer Configuration
  <buffer tag>
    @type file
    path /var/log/fluentd/azureeventhubs-production

    # Flush configuration
    flush_mode interval
    flush_interval 30s
    flush_at_shutdown true

    # Chunk configuration
    chunk_limit_size 10M
    total_limit_size 1G
    chunk_full_threshold 0.9

    # Retry configuration
    retry_max_times 20
    retry_wait 5s
    retry_exponential_backoff_base 2
    retry_max_interval 600s
    retry_randomize true
    retry_forever false

    # Performance tuning
    flush_thread_count 4
    compress gzip

    # Overflow handling
    overflow_action drop_oldest_chunk
  </buffer>

  # Slow flush log threshold
  <slow_flush_log_threshold>
    emit 30.0
  </slow_flush_log_threshold>
</match>

# Separate configuration for error logs with higher priority
<match error.**>
  @type azureeventhubs

  connection_string "#{ENV['AZURE_EVENTHUBS_CONNECTION_STRING']}"
  hub_name error-logs

  include_tag true
  include_time true

  # No batching for errors - send immediately
  batch false

  message_properties {
    "PartitionKey": "errors",
    "severity": "error"
  }

  <buffer>
    @type memory
    flush_interval 1s  # Flush errors quickly
    retry_max_times 30
  </buffer>
</match>
