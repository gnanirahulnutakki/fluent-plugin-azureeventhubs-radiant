# Azure Event Hubs Configuration for Kubernetes Logs
#
# Optimized for collecting logs from Kubernetes clusters

<match kubernetes.**>
  @type azureeventhubs

  connection_string "#{ENV['AZURE_EVENTHUBS_CONNECTION_STRING']}"
  hub_name kubernetes-logs

  # Include Kubernetes metadata
  include_tag true
  include_time true
  tag_time_name @timestamp

  # Batch mode for better throughput
  batch true
  max_batch_size 100

  # UTF-8 encoding for container logs
  coerce_to_utf8 true
  non_utf8_replacement_string " "

  # Custom properties for Event Hubs
  message_properties {
    "source": "kubernetes",
    "cluster": "production-cluster"
  }

  <buffer tag>
    @type file
    path /var/log/fluentd/k8s-eventhubs
    flush_interval 15s
    flush_mode interval
    chunk_limit_size 10M

    # Retry configuration for reliability
    retry_max_times 10
    retry_wait 10s
    retry_exponential_backoff_base 2
    retry_max_interval 300s

    # Handle overflow
    overflow_action drop_oldest_chunk
  </buffer>
</match>
